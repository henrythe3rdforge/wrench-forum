{% macro render_comment(comment, post_id, user, user_id, depth=0) %}
<div class="comment {% if comment.is_best_answer %}best-answer{% endif %}" id="comment-{{ comment.id }}" style="{% if depth > 0 %}margin-left: {{ depth * 24 }}px;{% endif %}">
    {% if comment.is_best_answer %}
    <div class="best-answer-badge mb-4">‚úì Best Answer</div>
    {% endif %}
    
    <div class="comment-votes">
        {% if user %}
        <button class="vote-btn upvote {% if comment.user_vote == 1 %}voted{% endif %}"
                hx-post="/comment/{{ comment.id }}/vote"
                hx-vals='{"value": 1}'
                hx-target="#comment-score-{{ comment.id }}"
                hx-swap="innerHTML">‚ñ≤</button>
        {% else %}
        <span class="vote-btn disabled">‚ñ≤</span>
        {% endif %}
        
        <span id="comment-score-{{ comment.id }}" class="score">{{ comment.score }}</span>
        
        {% if user %}
        <button class="vote-btn downvote {% if comment.user_vote == -1 %}voted{% endif %}"
                hx-post="/comment/{{ comment.id }}/vote"
                hx-vals='{"value": -1}'
                hx-target="#comment-score-{{ comment.id }}"
                hx-swap="innerHTML">‚ñº</button>
        {% else %}
        <span class="vote-btn disabled">‚ñº</span>
        {% endif %}
    </div>
    
    <div class="comment-main">
        <div class="comment-header">
            <a href="/user/{{ comment.username }}" class="comment-author">{{ comment.username }}</a>
            {% if comment.user_role == "verified_mechanic" %}
            <span class="badge verified">üîß</span>
            {% elif comment.user_role == "moderator" %}
            <span class="badge mod">üõ°Ô∏è</span>
            {% elif comment.user_role == "admin" %}
            <span class="badge admin">‚≠ê</span>
            {% endif %}
            <span class="comment-time">{{ comment.created_at }}</span>
            {% if comment.edited_at %}
            <span class="edited-indicator">(edited)</span>
            {% endif %}
        </div>
        
        <div class="comment-body">
            {% if comment.body_html %}
            {{ comment.body_html | safe }}
            {% else %}
            {{ comment.body }}
            {% endif %}
        </div>
        
        <div class="comment-actions">
            {% if user %}
            <button class="comment-action" onclick="toggleReplyForm({{ comment.id }})">Reply</button>
            
            {% if user_id == comment.user_id %}
            <button class="comment-action" onclick="toggleEditForm({{ comment.id }})">Edit</button>
            <button class="comment-action text-danger" 
                    hx-post="/comment/{{ comment.id }}/delete"
                    hx-target="#comment-{{ comment.id }}"
                    hx-swap="outerHTML"
                    hx-confirm="Delete this comment?">Delete</button>
            {% endif %}
            
            <!-- Mark as best answer (for post owner) -->
            {% if not comment.is_best_answer %}
            <form style="display: inline;" hx-post="/post/{{ post_id }}/best-answer/{{ comment.id }}" hx-swap="none">
                <button type="submit" class="comment-action">‚úì Best Answer</button>
            </form>
            {% endif %}
            
            <button class="comment-action" onclick="toggleReportForm({{ comment.id }})">Report</button>
            
            <!-- Mod actions -->
            {% if user.role == "Admin" or user.role == "Moderator" %}
            <button class="comment-action text-danger"
                    hx-post="/mod/comment/{{ comment.id }}/remove"
                    hx-target="#comment-{{ comment.id }}"
                    hx-swap="outerHTML">Remove</button>
            {% endif %}
            {% endif %}
        </div>
        
        <!-- Reply Form (hidden by default) -->
        {% if user %}
        <div id="reply-form-{{ comment.id }}" class="reply-form-inline" style="display: none;">
            <form hx-post="/post/{{ post_id }}/comment" hx-target="#comments-list" hx-swap="innerHTML">
                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                <textarea name="body" placeholder="Write a reply..." required></textarea>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary btn-sm">Reply</button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="toggleReplyForm({{ comment.id }})">Cancel</button>
                </div>
            </form>
        </div>
        
        <!-- Edit Form (hidden by default) -->
        <div id="edit-form-{{ comment.id }}" class="reply-form-inline" style="display: none;">
            <form hx-post="/comment/{{ comment.id }}/edit" hx-swap="outerHTML">
                <textarea name="body" required>{{ comment.body }}</textarea>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary btn-sm">Save</button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="toggleEditForm({{ comment.id }})">Cancel</button>
                </div>
            </form>
        </div>
        
        <!-- Report Form (hidden by default) -->
        <div id="report-form-{{ comment.id }}" class="reply-form-inline" style="display: none;">
            <form hx-post="/comment/{{ comment.id }}/report" hx-swap="innerHTML">
                <textarea name="reason" placeholder="Reason for report..." required></textarea>
                <div class="btn-group">
                    <button type="submit" class="btn btn-danger btn-sm">Report</button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="toggleReportForm({{ comment.id }})">Cancel</button>
                </div>
            </form>
        </div>
        {% endif %}
        
        <!-- Nested Replies -->
        {% if comment.replies %}
        <div class="comment-replies">
            {% for reply in comment.replies %}
            {{ self::render_comment(comment=reply, post_id=post_id, user=user, user_id=user_id, depth=depth + 1) }}
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% if comments %}
    {% for comment in comments %}
    {{ self::render_comment(comment=comment, post_id=post_id, user=user, user_id=user_id, depth=0) }}
    {% endfor %}
{% else %}
<div class="empty-state">
    <div class="empty-state-icon">üí¨</div>
    <h3 class="empty-state-title">No comments yet</h3>
    <p class="empty-state-text">Be the first to share your thoughts!</p>
</div>
{% endif %}

<script>
function toggleReplyForm(commentId) {
    const form = document.getElementById('reply-form-' + commentId);
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function toggleEditForm(commentId) {
    const form = document.getElementById('edit-form-' + commentId);
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function toggleReportForm(commentId) {
    const form = document.getElementById('report-form-' + commentId);
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}
</script>
