{% extends "base.html" %}

{% block title %}{{ post.title }} - Wrench Forum{% endblock %}

{% block content %}
<div class="container-narrow">
    <!-- Post Detail -->
    <article class="post-detail">
        <div class="post-detail-header">
            <div class="vote-controls">
                {% if user %}
                <button class="vote-btn upvote {% if post.user_vote == 1 %}voted{% endif %}" 
                        hx-post="/post/{{ post.id }}/vote" 
                        hx-vals='{"value": 1}'
                        hx-target="#post-score"
                        hx-swap="outerHTML">‚ñ≤</button>
                {% else %}
                <span class="vote-btn disabled">‚ñ≤</span>
                {% endif %}
                
                <span id="post-score" class="score">{{ post.score }}</span>
                
                {% if user %}
                <button class="vote-btn downvote {% if post.user_vote == -1 %}voted{% endif %}" 
                        hx-post="/post/{{ post.id }}/vote" 
                        hx-vals='{"value": -1}'
                        hx-target="#post-score"
                        hx-swap="outerHTML">‚ñº</button>
                {% else %}
                <span class="vote-btn disabled">‚ñº</span>
                {% endif %}
            </div>
            
            <div style="flex: 1;">
                {% if post.pinned %}
                <span class="post-tag" style="background: rgba(234, 179, 8, 0.2); color: #fbbf24; margin-bottom: 8px; display: inline-block;">üìå Pinned</span>
                {% endif %}
                
                {% if post.tags %}
                <div class="post-tags">
                    {% for tag in post.tags %}
                    <span class="post-tag" style="background: {{ tag.color }}20; color: {{ tag.color }}">{{ tag.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <h1 class="post-detail-title">{{ post.title }}</h1>
                
                <div class="post-meta">
                    <span class="meta-item">
                        <a href="/category/{{ post.category_slug }}">{{ post.category_name }}</a>
                    </span>
                    <span class="meta-separator">‚Ä¢</span>
                    <span class="meta-item">
                        by <a href="/user/{{ post.username }}">{{ post.username }}</a>
                        {% if post.user_role == "verified_mechanic" %}
                        <span class="badge verified">üîß Verified</span>
                        {% elif post.user_role == "moderator" %}
                        <span class="badge mod">üõ°Ô∏è Mod</span>
                        {% elif post.user_role == "admin" %}
                        <span class="badge admin">‚≠ê Admin</span>
                        {% endif %}
                    </span>
                    <span class="meta-separator">‚Ä¢</span>
                    <span class="meta-item">{{ post.created_at }}</span>
                    {% if post.edited_at %}
                    <span class="meta-separator">‚Ä¢</span>
                    <span class="meta-item edited-indicator">edited</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="post-detail-body">
            {% if post.body_html %}
            {{ post.body_html | safe }}
            {% else %}
            <p>{{ post.body }}</p>
            {% endif %}
        </div>
        
        <div class="post-actions">
            {% if user %}
            <!-- Bookmark -->
            <button class="action-btn {% if post.is_bookmarked %}bookmarked{% endif %}" 
                    hx-post="/post/{{ post.id }}/bookmark"
                    hx-swap="outerHTML">
                üîñ {% if post.is_bookmarked %}Saved{% else %}Save{% endif %}
            </button>
            
            <!-- Share -->
            <button class="action-btn" onclick="navigator.clipboard.writeText(window.location.href); this.textContent='‚úì Copied!'">
                üîó Share
            </button>
            
            <!-- Edit (if owner) -->
            {% if user_id == post.user_id %}
            <a href="/post/{{ post.id }}/edit" class="action-btn">‚úèÔ∏è Edit</a>
            {% endif %}
            
            <!-- Report -->
            <button class="action-btn" onclick="document.getElementById('report-modal').style.display='flex'">
                üö© Report
            </button>
            
            <!-- Mod Actions -->
            {% if user.role == "Admin" or user.role == "Moderator" %}
            <button class="action-btn" hx-post="/mod/post/{{ post.id }}/pin" hx-swap="none">
                üìå {% if post.pinned %}Unpin{% else %}Pin{% endif %}
            </button>
            <button class="action-btn text-danger" 
                    hx-post="/mod/post/{{ post.id }}/remove"
                    hx-confirm="Remove this post?">
                üóëÔ∏è Remove
            </button>
            {% endif %}
            {% endif %}
        </div>
    </article>
    
    <!-- Report Modal -->
    {% if user %}
    <div id="report-modal" class="modal-backdrop" style="display: none;" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Report Post</h3>
                <button class="modal-close" onclick="document.getElementById('report-modal').style.display='none'">√ó</button>
            </div>
            <form class="modal-body" hx-post="/post/{{ post.id }}/report" hx-swap="outerHTML">
                <div class="form-group">
                    <label class="form-label">Reason for report</label>
                    <textarea name="reason" placeholder="Describe why this post should be reviewed..." required></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-danger">Submit Report</button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('report-modal').style.display='none'">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    
    <!-- Comments Section -->
    <section class="comments-section">
        <div class="comments-header">
            <h2 class="comments-title">{{ comment_count }} Comments</h2>
            <select class="comment-sort-select" onchange="window.location.href='/post/{{ post.id }}?sort='+this.value">
                <option value="best" {% if comment_sort == 'best' %}selected{% endif %}>Best</option>
                <option value="new" {% if comment_sort == 'new' %}selected{% endif %}>Newest</option>
                <option value="old" {% if comment_sort == 'old' %}selected{% endif %}>Oldest</option>
                <option value="controversial" {% if comment_sort == 'controversial' %}selected{% endif %}>Controversial</option>
            </select>
        </div>
        
        {% if user %}
        <form class="comment-form" hx-post="/post/{{ post.id }}/comment" hx-target="#comments-list" hx-swap="innerHTML">
            <textarea name="body" placeholder="Share your expertise..." required></textarea>
            <div class="flex items-center justify-between">
                <span class="text-muted text-sm">Supports **bold**, *italic*, `code`, and [links](url)</span>
                <button type="submit" class="btn btn-primary">
                    <span class="htmx-indicator spinner"></span>
                    Post Comment
                </button>
            </div>
        </form>
        {% else %}
        <div class="comment-form text-center">
            <p class="text-muted mb-4">Join the discussion</p>
            <a href="/login" class="btn btn-primary">Log in to comment</a>
        </div>
        {% endif %}
        
        <div id="comments-list" class="comments-list">
            {% include "partials/comments.html" %}
        </div>
    </section>
</div>
{% endblock %}
