{% extends "base.html" %}

{% block title %}Wrench Forum - Home{% endblock %}

{% block content %}
<!-- Announcements -->
{% for announcement in announcements %}
<div class="announcement-banner {{ announcement.announcement_type }}">
    <span class="announcement-icon">
        {% if announcement.announcement_type == "warning" %}‚ö†Ô∏è{% elif announcement.announcement_type == "success" %}‚úÖ{% else %}üì¢{% endif %}
    </span>
    <div class="announcement-content">
        <div class="announcement-title">{{ announcement.title }}</div>
        <div class="announcement-text">{{ announcement.content }}</div>
    </div>
</div>
{% endfor %}

<div class="forum-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <!-- Categories -->
        <div class="sidebar-card">
            <div class="sidebar-header">Categories</div>
            <ul class="category-list">
                {% for cat in categories %}
                <li class="category-item">
                    <a href="/category/{{ cat.slug }}" class="category-link {% if current_slug == cat.slug %}active{% endif %}">
                        <span class="category-icon">{{ cat.icon | default(value="üìÅ") }}</span>
                        <span class="category-name">{{ cat.name }}</span>
                        {% if cat.post_count %}
                        <span class="category-count">{{ cat.post_count }}</span>
                        {% endif %}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        
        <!-- Post Button -->
        <div class="sidebar-card">
            <div class="sidebar-action">
                {% if user and user.role != "Unverified" %}
                <a href="/post/new" class="btn btn-primary btn-block">‚úèÔ∏è New Post</a>
                {% elif user %}
                <div class="text-center">
                    <p class="text-muted text-sm mb-4">Verify to post</p>
                    <a href="/verification" class="btn btn-secondary btn-block">Get Verified</a>
                </div>
                {% else %}
                <p class="text-center text-muted text-sm mb-4">Join to participate</p>
                <a href="/register" class="btn btn-primary btn-block">Sign Up</a>
                {% endif %}
            </div>
        </div>
        
        <!-- Forum Stats -->
        {% if stats %}
        <div class="sidebar-card">
            <div class="sidebar-header">Community</div>
            <div class="sidebar-stats">
                <div class="stat-item">
                    <div class="stat-value">{{ stats.total_users }}</div>
                    <div class="stat-label">Members</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ stats.verified_users }}</div>
                    <div class="stat-label">Verified</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ stats.total_posts }}</div>
                    <div class="stat-label">Posts</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ stats.posts_today }}</div>
                    <div class="stat-label">Today</div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Trending -->
        {% if trending %}
        <div class="sidebar-card">
            <div class="sidebar-header">üî• Trending</div>
            <div class="trending-list">
                {% for post in trending %}
                <div class="trending-item">
                    <span class="trending-rank">{{ loop.index }}</span>
                    <div class="trending-content">
                        <a href="/post/{{ post.id }}" class="trending-title">{{ post.title }}</a>
                        <div class="trending-meta">{{ post.score }} points ‚Ä¢ {{ post.comment_count | default(value=0) }} comments</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </aside>
    
    <!-- Main Content -->
    <section class="main-content">
        <!-- Sort Tabs -->
        <div class="sort-tabs">
            <a href="/?sort=hot" class="sort-tab {% if sort == 'hot' %}active{% endif %}">
                üî• Hot
            </a>
            <a href="/?sort=new" class="sort-tab {% if sort == 'new' %}active{% endif %}">
                üïê New
            </a>
            <a href="/?sort=top" class="sort-tab {% if sort == 'top' %}active{% endif %}">
                ‚¨ÜÔ∏è Top
            </a>
        </div>
        
        <!-- Post List -->
        <div class="post-list" id="post-list">
            {% for post in posts %}
            <article class="post-card {% if post.pinned %}pinned{% endif %}">
                <div class="vote-controls">
                    {% if user %}
                    <button class="vote-btn upvote {% if post.user_vote == 1 %}voted{% endif %}" 
                            hx-post="/post/{{ post.id }}/vote" 
                            hx-vals='{"value": 1}'
                            hx-target="#score-{{ post.id }}"
                            hx-swap="outerHTML">‚ñ≤</button>
                    {% else %}
                    <span class="vote-btn disabled">‚ñ≤</span>
                    {% endif %}
                    
                    <span id="score-{{ post.id }}" class="score">{{ post.score }}</span>
                    
                    {% if user %}
                    <button class="vote-btn downvote {% if post.user_vote == -1 %}voted{% endif %}" 
                            hx-post="/post/{{ post.id }}/vote" 
                            hx-vals='{"value": -1}'
                            hx-target="#score-{{ post.id }}"
                            hx-swap="outerHTML">‚ñº</button>
                    {% else %}
                    <span class="vote-btn disabled">‚ñº</span>
                    {% endif %}
                </div>
                
                <div class="post-content">
                    {% if post.pinned %}
                    <span class="post-tag" style="background: rgba(234, 179, 8, 0.2); color: #fbbf24;">üìå Pinned</span>
                    {% endif %}
                    
                    {% if post.tags %}
                    <div class="post-tags">
                        {% for tag in post.tags %}
                        <span class="post-tag" style="background: {{ tag.color }}20; color: {{ tag.color }}">{{ tag.name }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <h2 class="post-title">
                        <a href="/post/{{ post.id }}">{{ post.title }}</a>
                        {% if post.best_answer_id %}
                        <span class="badge verified" title="Has best answer">‚úì</span>
                        {% endif %}
                    </h2>
                    
                    <div class="post-meta">
                        <span class="meta-item">
                            <a href="/category/{{ post.category_slug }}">{{ post.category_name }}</a>
                        </span>
                        <span class="meta-separator">‚Ä¢</span>
                        <span class="meta-item">
                            by <a href="/user/{{ post.username }}">{{ post.username }}</a>
                            {% if post.user_role == "verified_mechanic" %}
                            <span class="badge verified" title="Verified Mechanic">üîß</span>
                            {% elif post.user_role == "moderator" %}
                            <span class="badge mod" title="Moderator">üõ°Ô∏è</span>
                            {% elif post.user_role == "admin" %}
                            <span class="badge admin" title="Admin">‚≠ê</span>
                            {% endif %}
                            {% if post.user_flair %}
                            <span class="user-flair">{{ post.user_flair }}</span>
                            {% endif %}
                        </span>
                        <span class="meta-separator">‚Ä¢</span>
                        <span class="meta-item">üí¨ {{ post.comment_count | default(value=0) }}</span>
                        <span class="meta-separator">‚Ä¢</span>
                        <span class="meta-item time">{{ post.created_at }}</span>
                    </div>
                </div>
            </article>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <h3 class="empty-state-title">No posts yet</h3>
                <p class="empty-state-text">Be the first to start a discussion!</p>
                {% if user and user.role != "Unverified" %}
                <a href="/post/new" class="btn btn-primary">Create Post</a>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if pagination and pagination.total_pages > 1 %}
        <div class="pagination">
            {% if pagination.has_prev %}
            <a href="/?sort={{ sort }}&page={{ pagination.page - 1 }}" class="pagination-btn">‚Üê Prev</a>
            {% else %}
            <span class="pagination-btn disabled">‚Üê Prev</span>
            {% endif %}
            
            <span class="pagination-btn">{{ pagination.page }} / {{ pagination.total_pages }}</span>
            
            {% if pagination.has_next %}
            <a href="/?sort={{ sort }}&page={{ pagination.page + 1 }}" class="pagination-btn">Next ‚Üí</a>
            {% else %}
            <span class="pagination-btn disabled">Next ‚Üí</span>
            {% endif %}
        </div>
        {% endif %}
    </section>
</div>
{% endblock %}
